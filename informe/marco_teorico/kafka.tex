%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%																				%
%	TRABAJO:	Trabajo Final													%
%				Especialidad en Ingeniería en Sistemas de Información			%
%																				%
%		Titulo:																	%
%																				%
%		Autores:	Julian Nonino												%
%																				%
%	Capitulo sobre Apache Kafka													%	
%																				%
%	Año: 2016																	%
%																				%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Apache Kafka}
\label{chapter_apache_kafka}

Kafka es un sistema de mensajes distribuido, particionado y con
replicación\cite{ApacheKafka090}.

\begin{itemize}
    \item Kafka mantiene los mensajes agrupados en categorías llamadas
    \emph{topics.}
	\item Los productores de mensajes se llaman \emph{producers}.
	\item Los consumidores de mensajes se llaman \emph{consumers}.
	\item Kafka corre en un cluster formado por uno o mas servidores. cada uno de
	ellos es llamado \emph{broker}.
\end{itemize}

\begin{figure}[H]
	\centering
	\includegraphics[width=.5\linewidth]{./marco_teorico/img/kafka/high_level_arch}
	\caption{Kafka, arquitectura de alto nivel\cite{ApacheKafka090}}
\end{figure}

\section{Topics}

	Los \emph{topics} de Kafka son categorías de mensajes para los cuales Kafka
	mantiene registros particionados.
	
	Cada partición es una secuencia ordenada e inmutable de mensajes. El número de
	orden de cada mensaje es llamado \emph{offset} e identifica univocamente a cada
	mensaje de la partición.
	
	Kafka mantiene los mensajes publicados por un período de tiempo configurable,
	sin importar si fueron consumidos o no por algún proceso \emph{consumer}. Cada
	consumidor se encarga de mantener el \emph{offset} y tiene libertad para ir
	hacia atrás y hacia adelante en los mensajes publicados para procesarlos.
	
	El tener los mensajes de un \emph{topic} particionados permite separar el
	\emph{topic} en varios servidores. Ésto permite manejar grandes volumenes de
	datos y además otorogar un nivel superior de paralelismo.
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=.5\linewidth]{./marco_teorico/img/kafka/kafka_topics}
		\caption{Topics en Kafka\cite{ApacheKafka090}}
	\end{figure}
	
	Cada partición está formada por un líder (\emph{leader}) que se encuentra en
	uno de los servidores y por cero o más seguidores (\emph{followers}) que
	replican al líder todo el tiempo en servidores distintos. Si el líder falla,
	alguno de los seguidores se convertirá en el nuevo líder garantizando que el
	sistema siga operando. la configuración ideal es que cada servidor sea líder de
	alguna partición y seguidor de las otras.
	
\section{Productores}
	
	Los productores en Kafka son programas encargados de publicar datos en los
	\emph{topics}. El productor decide, para cada mensaje, el topic y la partición
	en el cual publicarlo. Generalmente la partición es elegida siguiendo un
	esquema \emph{round-robin} para lograr un óptimo balance de carga entre
	particiones, pero se puede utilizar cualquier lógica.
	
\section{Consumidores}

	Los sitemas de mensajería pueden ser clasificados en dos categorías,
	\emph{cola de mensajes} o \emph{publicación-subscripción}. En el primero, los
	mensajes son encolados y cada mensaje es dirigido hacia alguno de los
	consumidores. En el segundo, cada mensaje es transmitido a todos los
	consumidores. kafka maneja ambos mundos con lo que se conoce como grupos de
	consumidores (\emph{consumer groups}).
	
	Cada consumidor debe ubicarse dentro de alguno de los grupos de consumidores y
	cuando un mensajes es publicado en un \emph{topic}, el mensaje es transmitido a
	un único consumidor de cada uno de los grupos de consumidores.
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=.5\linewidth]{./marco_teorico/img/kafka/kafka_consumers}
		\caption{Grupos de Consumidores\cite{ApacheKafka090}}
	\end{figure}	
	
	Si todos los consumidores se encuentran en el mismo grupo, el sistema funciona
	como una cola de mensajes distribuyendo la carga entre cada uno de los
	consumidores.
	
	Si todos los consumidores se encuentran en distintos grupos, el sistema
	funciona como un sistema publicación-subscripción y todos los mensajes son
	transmitidos a todos los consumidores.
	